# 第二章 组合：核心结构与完整规则

组合是 HAM 三大原语中负责**结构与组织**的核心，是整个语言里使用最广泛、最基础的构造。
对象、模块、配置、函数体、执行单元，全部都由组合统一实现。
它的语法、语义、行为全程保持一致，没有例外、没有特殊规则。

---

## 2.1 组合的基本语法
组合由一对大括号 `{ }` 包裹，内部是**键值对声明**。
多个键值对之间，使用**逗号**分隔。

最基本形式：
```ham
{
  a = 1,
  b = 2,
  c = 3
}
```
每一个组合，本身就是一个**值**，可以直接使用、传递、嵌套、被导入或被覆盖。

---

## 2.2 组合是严格有序的
组合内部遵循**从上到下顺序绑定**：
- 先写的先生效
- 后面只能引用前面已经定义过的名称
- 不允许向前引用
- 天然不存在循环依赖

这让组合的行为**完全可预测、可推理**。

---

## 2.3 同名覆盖：后面覆盖前面
同一个组合内部，如果出现同名的键，**后出现的覆盖先出现的**。

示例：
```ham
{
  x = 10,
  x = 999
}
```
最终这个组合里 `x` 的值为 **999**。

覆盖不是修改、不是赋值，而是**声明式替换**，这也是 HAM 实现扩展、重载、插件化的核心机制。

---

## 2.4 键名命名规则
组合中的键名遵循统一规范：
- 可以由字母、数字、下划线组成
- 必须以字母或下划线开头
- 区分大小写
- 不能使用空格或普通特殊符号

合法键名：
```
name,
user_name,
_private,
value123
```
---

## 2.5 # 开头的特殊键
`#` 是一个特殊前缀，用于标识**元键、内部键、系统键**。

- 以 `#` 开头的键不属于普通业务命名空间
- 主要用于存放类型信息、元数据、内部标记等
- 不会与普通键冲突，也不参与常规遍历与覆盖

示例：
```ham
{
  #type = "User",
  name = "ham",
  age = 1
}
```
`#` 前缀 = 系统/内部/元信息。

---

## 2.6 键值对的两种声明方式：`=` 与 `<-`
这是 HAM 组合最核心的语义区分，**只与递归可见性有关**。

### 2.6.1 非递归绑定：`key = 表达式`
- 等号**右侧看不见**当前正在声明的 `key`
- 如果右侧用到 `key`，只会引用**更早定义**的同名键
- 行为接近程序员熟悉的**赋值/覆盖**
```ham
{
  x = 1,
  y = x + 1
}
```
### 2.6.2 递归绑定：`key <- 表达式`
- 箭头**右侧能看见**当前这个 `key` 本身
- 右侧使用 `key` 代表**正在定义的自己**
- 是 HAM 实现**递归、自引用、相互递归**的唯一方式
```ham
{
  fact <- n => if n == 0 then 1 else n * fact(n - 1)
}
```
### 一句话总结
- `=`  右边看不见自己 → 不递归
- `<-` 右边看得见自己 → 可递归

---

## 2.7 组合可以直接使用，不必先命名
因为组合本身就是值，所以可以**直接写、直接用**，不需要先赋值给变量。

合法写法：
```ham
{ a = 1 }.a
```
结果就是 1。

这是典型的 λ 演算风格：**构造即使用，不必命名**。

---

## 2.8 成员访问：点 `.` 语法
任何组合值后面，都可以直接用 `.key` 访问成员：
```ham
{
  user = {
    name = "ham",
    age = 1
  }
}.user.name
```
`.` 作用于**值**，而不是作用于变量名。
这也是 HAM 语法高度统一的关键。

---

## 2.9 组合嵌套
组合内部可以无限嵌套组合：
```ham
{
  a = {
    b = {
      c = 100
    }
  }
}
```
访问方式：
```ham
a.b.c
```
嵌套结构 + 有序覆盖 + 点访问，三者一起构成了 HAM 的完整结构化能力。

---

## 2.10 组合与模块的关系
一个 `.ham` 文件 = 一个顶层组合。
通过 `import("file.ham")` 得到的，就是这个组合。

所以：
```ham
mod = import("utils.ham"),
mod.func()
```
和普通组合的使用方式完全一致。
**模块本质就是组合**，没有任何区别。

---

## 2.11 本章小结
- 组合用 `{ }` 表示，内部键值对用逗号分隔
- 组合是值，可以直接使用、嵌套、传递
- 严格从上到下执行，后面覆盖前面
- 键名支持普通命名与 `#` 特殊前缀
- 两种声明方式：
  - `=` 非递归绑定（右边看不见自己）
  - `<-` 递归绑定（右边能看见自己）
- 点 `.` 语法用于成员访问
- 模块本质就是组合
- 全程声明式、无变量、无副作用、纯结构化

HAM 所有上层能力：对象、封装、扩展、覆盖、插件化、递归，都建立在本章规则之上。
