# 第十一章 惰性求值与并行求值（完整定稿）

## 11.1 本章概览
在完成函子、应用式与单子的核心抽象模型学习后，我们暂时离开纯理论抽象，转向工程实践中最关键的两大运行机制：**惰性求值**与**自动并行求值**。

本章不新增理论复杂度，不强行关联指针模型，以直观、声明式的方式，介绍 HAM 语言最核心的运行特性，采用螺旋上升的学习节奏，让理论落地到真实工程问题，为后续实践章节打下更稳固的基础。

## 11.2 惰性求值：HAM 唯一且强制的求值策略
在 HAM 中，所有表达式、所有绑定、所有组合，**强制且一律是惰性求值**。
这不是可选项，不是优化，而是语言底层的基础规则。

含义非常简单：
**只在真正需要结果的时候，才开始计算；没有被用到的部分，永远不会执行。**

## 11.3 惰性带来的核心能力：安全的无限结构
因为 HAM 是强制惰性，所以可以安全地声明无限结构。

- HAM 本身**不内置**无限列表、无限树这类结构
- 但用户**可以通过组合与函数自行定义**
- 惰性求值保证：**只展开你真正用到的部分**

无限结构分为两类：
- **安全的无限**：有基线、自展开、可安全取值
- **不安全的无限**：无基线、反向依赖、无法终止计算

## 11.4 示例一：安全的无限树
规则：
- 根节点值为 1
- 每个子节点的值 = 父节点值 + 1
```ham
{
  nextTree = (parent) => {
    value = parent.value + 1,
    left  = nextTree(parent),
    right = nextTree(parent)
  },

  safeTree ← {
    value = 1,
    left  = nextTree(safeTree),
    right = nextTree(safeTree)
  },

  result = safeTree.left.value
}
```
## 11.5 示例二：不安全的无限树
规则：
- 节点的值 = 左子节点值 + 右子节点值
```ham
{
  unsafeTree ← {
    left  = unsafeTree,
    right = unsafeTree,
    value = unsafeTree.left.value + unsafeTree.right.value
  },

  result = unsafeTree.value
}
```
## 11.6 并行与线性求值：编译器自动调度
HAM 中，用户只描述数据依赖关系，**由编译器决定是否并行**。
用户无需编写线程、协程、锁、同步等底层机制。

并行/线性求值的控制分为四级，优先级从高到低：
1. 代码内部注解
2. 文件头注释中的元数据（模块级）
3. 包配置
4. 编译命令

## 11.7 代码内注解
使用直观注解：
- @parallel 建议并行求值
- @linear 强制线性求值
```ham
{
  nextTree = (parent) => {
    value = parent.value + 1,
    left  = nextTree(parent),
    right = nextTree(parent)
  },

  safeTree ← {
    value = 1,
    left  = nextTree(safeTree),
    right = nextTree(safeTree)
  },

  @parallel
  leftValue = safeTree.left.value,

  @parallel
  rightValue = safeTree.right.value,

  result = leftValue + rightValue
}
```
## 11.8 文件头元数据（写在文件头注释）
元数据写在文件顶部的 /** 注释中，控制整个模块的默认行为。
```ham
/**
 * @parallel
 * 本模块默认启用并行求值
 */
{
  // 模块内容
}

/**
 * @linear
 * 本模块强制使用线性求值
 */
{
  // 模块内容
}
```
## 11.9 包配置与编译命令
更上层的全局控制：
- 包配置文件：对整个包设置默认策略
- 编译命令：全局开关
  - ham build --parallel=auto
  - ham build --parallel=off

## 11.10 并行求值的安全保证
HAM 并行天然安全，因为：
- 所有数据不可变
- 所有计算都是纯表达式
- 所有执行强制惰性
- 无共享可变状态
- 无副作用

因此天然无竞态、无死锁、无数据冲突。

## 11.11 本章小结
- HAM 采用**强制、唯一、无例外的惰性求值**
- 惰性允许用户**用组合与函数安全定义无限结构**
- 无限结构分为两类：
  - 安全无限：有基线、自展开、可正常取值
  - 不安全无限：无基线、反向依赖、无法终止计算
- 递归结构使用 ← 定义
- 并行/线性由**编译器自动调度**，用户仅提供意图
- 控制方式分为四级：
  1. 代码内注解
  2. 文件头注释元数据
  3. 包配置
  4. 编译命令
- 全程无锁、安全、零心智负担
